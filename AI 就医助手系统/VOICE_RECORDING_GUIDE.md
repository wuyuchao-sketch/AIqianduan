# 语音录制功能使用说明

## 修复内容

### 1. 后端连接配置
- 在 `vite.config.ts` 中添加了代理配置，将前端 `/api` 请求转发到后端 `http://localhost:8080`
- 添加了详细的代理日志，便于调试连接问题

### 2. 错误处理改进
- 增强了浏览器兼容性检查
- 添加了麦克风权限检查
- 改进了音频格式支持检测
- 增加了重试机制（最多3次）

### 3. 用户体验优化
- 添加了系统初始化检查
- 显示后端连接状态
- 显示媒体设备支持状态
- 更详细的错误信息提示

## 使用前准备

### 1. 启动后端服务
确保后端 Spring Boot 应用运行在 `http://localhost:8080`

### 2. 启动前端服务
```bash
cd "AI 就医助手系统"
npm run dev
```

### 3. 浏览器设置
- 使用现代浏览器（Chrome、Firefox、Edge）
- 允许麦克风权限
- 确保在 HTTPS 或 localhost 环境下运行

## 故障排除

### 录音失败常见原因

1. **后端服务未启动**
   - 检查后端服务是否在 8080 端口运行
   - 查看控制台是否显示"后端服务未连接"

2. **麦克风权限被拒绝**
   - 点击浏览器地址栏的麦克风图标
   - 选择"允许"麦克风访问

3. **浏览器不支持**
   - 使用 Chrome 88+ 或 Firefox 85+
   - 避免使用 IE 或过旧的浏览器

4. **网络连接问题**
   - 检查网络连接
   - 查看浏览器开发者工具的网络面板

### 调试步骤

1. 打开浏览器开发者工具（F12）
2. 查看 Console 面板的日志信息
3. 查看 Network 面板的 API 请求状态
4. 检查是否有 CORS 错误

## API 接口说明

### 健康检查
- **URL**: `/api/transcription/health`
- **方法**: GET
- **用途**: 检查后端服务状态

### 音频上传转录
- **URL**: `/api/transcription/upload`
- **方法**: POST
- **参数**:
  - `file`: 音频文件（PCM格式）
  - `userId`: 用户ID
  - `visitId`: 访问ID
  - `audioEncode`: 音频编码（默认：pcm_s16le）
  - `sampleRate`: 采样率（默认：16000）
  - `lang`: 语言（默认：autodialect）
  - `pd`: 领域（可选：medical）

## 技术细节

### 音频处理流程
1. 获取麦克风权限
2. 创建 MediaRecorder 实例
3. 录制音频数据
4. 转换为 PCM 格式
5. 上传到后端进行转录

### 支持的音频格式
- WebM (首选)
- MP4 (备选)
- 自动检测浏览器支持的格式